#!/usr/bin/env python3

import jinja2
import logging

TEMPLATE_FILE_PATH = "Dockerfile.assisted-service.jinja2"

CI_DOCKERFILE = "Dockerfile.assisted-service"
DEV_DOCKERFILE = "Dockerfile.assisted-service.dev"

logging.basicConfig(level=logging.INFO)

generated_warning = f"""
# This file was automatically generated by `hack/generate.sh generate_dockerfiles`
# PLEASE DO NOT MODIFY THIS FILE. Modify {TEMPLATE_FILE_PATH} instead,
# then rerun the above command.
""".strip()

def main():
    logging.info(f"Loading {TEMPLATE_FILE_PATH}")
    with open(TEMPLATE_FILE_PATH) as f:
        template_contents = f.read()

    template = jinja2.Template(template_contents)

    logging.info("Rendering CI template...")
    ci_rendered = template.render(generated_warning=generated_warning, build_go_inside_container=True)
    logging.info("Rendering dev template...")
    dev_rendered = template.render(generated_warning=generated_warning, build_go_inside_container=False)

    logging.info(f"Writing rendered CI template to {CI_DOCKERFILE}")
    with open(CI_DOCKERFILE, "w") as f:
        f.write(ci_rendered.strip())

    logging.info(f"Writing rendered dev template to {DEV_DOCKERFILE}")
    with open(DEV_DOCKERFILE, "w") as f:
        f.write(dev_rendered.strip())

if __name__ == "__main__":
    main()
